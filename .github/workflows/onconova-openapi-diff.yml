name: API Breaking Changes

on:
  pull_request:


env:
  CURRENT_BRANCH: ${{ github.head_ref }}
  TARGET_BRANCH: ${{ github.base_ref }}

jobs:
  build-oas-artefacts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v1
        with:
          node-version: '12.x'

      - name: Install required tools
        run: |
          npm install speccy -g
          npm install -g @openapitools/openapi-generator-cli@1.0.10-4.2.3

      - name: Clone repository in branch ${{ env.TARGET_BRANCH }}
        uses: actions/checkout@v2
        with:
          path: 'A'
          ref: ${{ github.base_ref }}

      - name: Clone repository in branch ${{ env.CURRENT_BRANCH }}
        uses: actions/checkout@v2
        with:
          path: 'B'

      - name: Check if OAS from ${{ env.CURRENT_BRANCH }} is valid
        run: |
          npx openapi-generator validate -i B/client/openapi.json

      - name: Check if OAS from ${{ env.TARGET_BRANCH }} is valid
        run: |
          npx openapi-generator validate -i A/client/openapi.json
          
      - name: Upload single OAS file from ${{ env.TARGET_BRANCH }}
        uses: actions/upload-artifact@v4
        with:
          name: original-spec.yaml
          path: original-spec.yaml
          
      - name: Upload single OAS file from ${{ env.CURRENT_BRANCH }}
        uses: actions/upload-artifact@v4
        with:
          name: modified-spec.yaml
          path: modified-spec.yaml

  build-report:
    needs: build-oas-artefacts
    runs-on: ubuntu-latest
    env:
      ORIGIN_SPEC: "${{ github.workspace }}/specs/original-spec.yaml"
      MODIFIED_SPEC: "${{ github.workspace }}/specs/modified-spec.yaml"
      SPECS_LOG: "${{ github.workspace }}/breaking-changes.log"
      JSON_DIFF_FILE: "${{ github.workspace }}/breaking-changes.json"
      GH_COMMENT_FILE: "${{ github.workspace }}/Github-comment.md"
    steps:
      - uses: actions/setup-node@v1
        with:
          node-version: '13.x'

      - name: Install required tools
        run: |
          npm install openapi-diff -g

      - name: Download OAS file from SOURCE branch
        uses: actions/download-artifact@v4
        with:
          name: original-spec.yaml
          path: specs/

      - name: Download OAS file from TARGET branch
        uses: actions/download-artifact@v4
        with:
          name: modified-spec.yaml
          path: specs/

      - name: Restore permissions
        run: |
          chmod -R 777 ${{ env.ORIGIN_SPEC }}
          chmod -R 777 ${{ env.MODIFIED_SPEC }}

      - name: Generate report
        run: |
          openapi-diff ${{ env.ORIGIN_SPEC }} ${{ env.MODIFIED_SPEC }} | tee ${{ env.SPECS_LOG }}
          sed -n '1!p' ${{ env.SPECS_LOG }} > ${{ env.JSON_DIFF_FILE }}

      - uses: actions/upload-artifact@v4
        with:
          name: openapi-diff.json
          path: breaking-changes.json

      - name: Prepare comment on Github PR
        run: |
          sed -n '1p' ${{ env.SPECS_LOG }} >> ${{ env.GH_COMMENT_FILE }}
          printf "\n\n\`\`\`yaml\n" >> ${{ env.GH_COMMENT_FILE }}
          sed -n '1!p' ${{ env.SPECS_LOG }} >> ${{ env.GH_COMMENT_FILE }}
          printf "\n\`\`\`\n" >> ${{ env.GH_COMMENT_FILE }}

      - name: comment PR
        uses: machine-learning-apps/pr-comment@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          path: Github-comment.md